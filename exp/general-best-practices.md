# 通用工程实践与风格指南（独立于具体项目）

## 依赖与版本
- **选择原则**：
  - 稳定版优先，锁定主版本（如 `reqwest 0.12`, `tokio 1`, `serde 1`），避免漂移。
  - 仅开启必要特性（如 `reqwest/json`，`tokio/full` 若确需完整异步栈）。
  - 错误处理统一：`thiserror` 自定义错误，`anyhow`/`eyre` 可用于应用层快速封装。
- **安全与兼容**：
  - 网络请求遵守超时/重试/错误回退；为 TLS/CA 配置留扩展位。
  - 注意 MSRV（最低支持 Rust 版本）与 CI 一致。

## 目录与模块组织
- **清晰分层**：
  - `src/lib.rs` 仅做对外导出和顶层文档。
  - 按领域拆子模块：`client/`, `central/`, `mcp/`, `bin/` 等；每个模块的 `mod.rs` 组织公共类型。
- **服务划分**：以资源/职责为单位（如 NetworkService/MemberService），使接口语义化，便于扩展。
- **入口最小化**：`src/bin/*.rs` 只做参数/env 解析与依赖装配，其余逻辑放库层。

## 代码风格与 Serde
- **命名直白**：函数即动作（`list`, `get`, `create`），类型即实体（`Network`, `Member`）。
- **Serde 约定**：
  - 统一 `#[serde(rename_all = "camelCase")]` 或项目约定的大小写。
  - 集合字段使用 `#[serde(default)]`，必要时自定义反序列化以容忍 `null` → 空集合（`null_default`）。
  - 可选字段 `Option<T>`，并在请求体用 `skip_serializing_if` 避免发送空值。
- **错误模型**：单一错误枚举，区分 HTTP / API / 序列化；接口返回 `Result<T, Error>`，调用侧早返回。

## 异步与网络
- **超时必设**：构建 HTTP client 时设置全局超时；长调用另设 per-request 超时。
- **Content-Type 与空体检查**：解析前检查状态码、头、空体，避免“2xx + 非 JSON/空响应”导致崩溃。
- **幂等与重试**：对 GET/HEAD 等可幂等操作，可配置性重试；写操作谨慎重试。

## 构建与发布
- **Release 构建**：`cargo build --release`；如需分发二进制，单独脚本复制到部署目录。
- **CI 建议**：格式化（`cargo fmt`）、lint（`cargo clippy -- -D warnings`）、测试（`cargo test`）、构建。
- **版本管理**：遵循 semver，更新时同步 `Cargo.toml` 与变更日志。

## 日志与诊断
- **结构化信息**：记录 URL、状态码、Content-Type、体长度；截断 body 片段即可。
- **开关控制**：通过 env/feature 开启调试日志，默认静默。
- **工具化诊断**：提供“原始响应查看”类工具/命令，便于快速定位数据问题。

## 测试与健壮性
- **契约测试**：为 API 结构设计容错（`null`、缺字段、空数组），用单元测试覆盖。
- **极端场景**：空响应、非 JSON、慢响应、无 Token、权限错误等路径要有明确错误信息。
- **最小注释**：仅在非直观逻辑处添加注释，保持代码可读性。

## 配置与注入
- **环境变量优先**：Token/端点从 env 读取，可选配置对象 `with_options` 支持覆盖 base_url/timeout。
- **依赖注入**：对外暴露 `with_*` 构造（如注入自定义 HTTP client/token），利于测试与多环境。

## MCP/工具层最佳实践（可泛化）
- **路由清晰**：每个工具一个职责，参数结构体带描述注解，便于前端/LLM 展示。
- **错误直出**：工具返回人类可读错误，必要时带原文片段；对未配置的依赖（如缺 Token）提前提示。
- **幂等安全**：对破坏性操作（删除/踢出）可加确认或只读模式。

## 常见错误与防范
- `null` → Vec/Map 解析失败：集合字段加 `default` + 自定义反序列化。
- 空/非 JSON 响应：解析前检查体与 Content-Type，必要时返回原文错误。
- Token 缺失：启动前校验或在工具层显式报“未配置 Token”。

## 扩展建议
- 封装诊断工具（原始响应、头信息摘要）。
- 在发布脚本中加入哈希校验与回滚方案。
- 为 API 客户端增加可选的重试策略与 metrics 钩子。
